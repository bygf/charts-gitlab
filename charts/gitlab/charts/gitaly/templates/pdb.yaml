{{- if .Values.global.gitaly.enabled -}}
{{- $storages := (dict "name" (.Values.global.gitaly.internal.names | first)) | list -}}
{{- if .Values.global.praefect.enabled -}}
{{-   $storages = .Values.global.praefect.virtualStorages -}}
{{- end -}}
{{ range $storages }}
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  {{- if $.Values.global.praefect.enabled }}
  name: {{ include "gitlab.gitaly.serviceName" (dict "context" $ "name" .name) }}
  {{- else }}
  name: {{ template "fullname" $ }}
  {{- end }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "gitlab.standardLabels" $ | nindent 4 }}
spec:
  maxUnavailable: {{ default $.Values.maxUnavailable .maxUnavailable }}
  selector:
    matchLabels:
      app: {{ template "name" $ }}
      release: {{ $.Release.Name }}
      storage: {{ .name }}
---
{{- end -}}
{{- end -}}
